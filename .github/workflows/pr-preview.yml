name: PR Preview
on:
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Build the project
        run: mkdocs build --site-dir site

      - name: Deploy PR Preview to gh-pages
        run: |
          git config --global user.name github-actions[bot]
          git config --global user.email 41898282+github-actions[bot]@users.noreply.github.com
          git fetch origin gh-pages
          git checkout gh-pages
          mkdir -p pr-preview/pr-${{ github.event.pull_request.number }}
          rm -rf pr-preview/pr-${{ github.event.pull_request.number }}/*
          cp -r site/* pr-preview/pr-${{ github.event.pull_request.number }}/
          git add pr-preview/pr-${{ github.event.pull_request.number }}
          git commit -m "PR #${{ github.event.pull_request.number }} preview" || echo "No changes to commit"
          git push origin gh-pages

      - name: Comment PR Preview URL
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT="ðŸš€ PR é¢„è§ˆå·²éƒ¨ç½²ï¼š[ç‚¹å‡»æŸ¥çœ‹](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-preview/pr-${{ github.event.pull_request.number }}/)"
          PR_API_URL="${{ github.event.pull_request.comments_url }}"
          curl -s -H "Authorization: token $GITHUB_TOKEN" -X POST -d "{\"body\": \"$COMMENT\"}" $PR_API_URL